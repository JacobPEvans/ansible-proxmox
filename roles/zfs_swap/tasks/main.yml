---
# ZFS Swap role tasks

- name: Check if ZFS swap dataset exists
  ansible.builtin.command:
    cmd: "zfs list {{ zfs_swap_pool }}/{{ zfs_swap_dataset }}"
  register: zfs_swap_check
  changed_when: false
  failed_when: false
  tags:
    - zfs_swap

- name: Get system page size
  ansible.builtin.command:
    cmd: getconf PAGESIZE
  register: zfs_swap_page_size
  changed_when: false
  tags:
    - zfs_swap

- name: Create ZFS swap ZVOL
  ansible.builtin.command:
    cmd: >-
      zfs create -V {{ zfs_swap_size }} -b {{ zfs_swap_page_size.stdout }}
      -o compression=zle
      -o sync=disabled
      -o primarycache=metadata
      -o secondarycache=none
      -o logbias=throughput
      {{ zfs_swap_pool }}/{{ zfs_swap_dataset }}
  when: zfs_swap_check.rc != 0
  changed_when: true
  tags:
    - zfs_swap

- name: Format swap device
  ansible.builtin.command:
    cmd: "mkswap {{ zfs_swap_device }}"
  when: zfs_swap_check.rc != 0
  changed_when: true
  tags:
    - zfs_swap

- name: Add swap to fstab
  ansible.posix.mount:
    path: none
    src: "{{ zfs_swap_device }}"
    fstype: swap
    opts: sw
    state: present
  tags:
    - zfs_swap

- name: Enable swap
  ansible.builtin.command:
    cmd: "swapon {{ zfs_swap_device }}"
  register: zfs_swap_swapon_result
  changed_when: zfs_swap_swapon_result.rc == 0
  failed_when: false
  tags:
    - zfs_swap
