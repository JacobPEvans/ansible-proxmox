---
# Crash Diagnostics role tasks

# =============================================================================
# PACKAGE INSTALLATION
# =============================================================================

- name: Install debugging and crash diagnostic packages
  ansible.builtin.apt:
    name: "{{ crash_diagnostics_packages }}"
    state: present
    update_cache: true
  tags:
    - crash_diagnostics
    - packages

# =============================================================================
# SYSCTL CONFIGURATION
# =============================================================================

- name: Remove old manual sysctl debug configs
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ crash_diagnostics_sysctl_cleanup }}"
  notify: Reload sysctl
  tags:
    - crash_diagnostics
    - sysctl

- name: Deploy sysctl crash diagnostics config
  ansible.builtin.template:
    src: sysctl.conf.j2
    dest: "{{ crash_diagnostics_sysctl_file }}"
    owner: root
    group: root
    mode: "0644"
    backup: true
  notify: Reload sysctl
  tags:
    - crash_diagnostics
    - sysctl

# =============================================================================
# GRUB CONFIGURATION
# =============================================================================

- name: Deploy GRUB drop-in config for crash diagnostics
  ansible.builtin.template:
    src: grub.cfg.j2
    dest: "{{ crash_diagnostics_grub_dropin }}"
    owner: root
    group: root
    mode: "0644"
    backup: true
  notify: Update GRUB
  tags:
    - crash_diagnostics
    - grub
